openapi: 3.0.3
info:
  title: LLT Assistant API
  description: |
    **Unified API Specification for LLT Assistant VSCode Extension.**

    **Core Philosophy: Frontend-First & Leaky Abstraction Avoidance**
    - The Backend provides business capabilities, not atomic code operations.
    - The Frontend handles local context (Git diffs, XML parsing, File reading).
    - Async workflows are used for heavy LLM operations.

    **Feature Map:**
    - **Feature 1 (Test Generation):** `/workflows/generate-tests` (Async)
    - **Feature 2 (Coverage Optimization):** `/optimization/coverage` (Async)
    - **Feature 3 (Impact Analysis):** `/analysis/impact` (Sync/Fast)
    - **Feature 4 (Quality Analysis):** `/quality/analyze` (Sync/Batch)
  version: 1.1.0
  contact:
    name: LLT Assistant Technical Team

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.llt-assistant.com
    description: Production server

tags:
  - name: System
    description: Health and System status
  - name: Context Management
    description: Phase 1 - Code graph initialization and incremental updates
  - name: Feature 1 - Generation
    description: Generate new tests from scratch or descriptions
  - name: Feature 2 - Coverage
    description: Analyze gaps and generate supplementary tests
  - name: Feature 3 - Impact
    description: Analyze code changes to find affected tests
  - name: Feature 4 - Quality
    description: Linting and quality analysis with auto-fixes
  - name: Tasks
    description: Polling for async workflows

paths:
  # ============================================================================
  # SYSTEM
  # ============================================================================
  /health:
    get:
      summary: System Health Check
      tags:
        - System
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded]
                  version:
                    type: string

  # ============================================================================
  # PHASE 1: Context Management (Code Graph)
  # ============================================================================
  /context/projects/initialize:
    post:
      summary: Initialize Project Code Graph
      description: |
        Initialize a new project's code dependency graph in Neo4j.
        Creates Symbol nodes and CALLS relationships for all provided files.
        Returns 409 if project already exists.
      tags:
        - Context Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitializeProjectRequest'
      responses:
        '201':
          description: Project initialized successfully
          headers:
            X-Request-ID:
              schema:
                type: string
                format: uuid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitializeProjectResponse'
        '409':
          description: Project already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error - empty files or no symbols
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                empty_files:
                  summary: Empty files array
                  value:
                    error: "Files array cannot be empty. At least one file with symbols is required."
                    error_code: EMPTY_FILES
                    details:
                      files_count: 0
                    request_id: "550e8400-e29b-41d4-a716-446655440000"
                    timestamp: "2025-11-25T10:30:00Z"
                    path: "/context/projects/initialize"
                no_symbols:
                  summary: Files with no symbols
                  value:
                    error: "All files contain no symbols. Cannot initialize empty project."
                    error_code: NO_SYMBOLS
                    details:
                      total_files: 3
                      files_with_symbols: 0
                    request_id: "550e8400-e29b-41d4-a716-446655440000"
                    timestamp: "2025-11-25T10:30:00Z"
                    path: "/context/projects/initialize"
        '503':
          description: Database unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /context/projects/{project_id}/incremental:
    patch:
      summary: Apply Incremental Updates
      description: |
        Apply incremental changes to project graph with optimistic locking.
        Uses version number to detect and prevent conflicts.
      tags:
        - Context Management
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
          description: Unique project identifier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IncrementalUpdateRequest'
      responses:
        '200':
          description: Update applied successfully
          headers:
            X-Request-ID:
              schema:
                type: string
                format: uuid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncrementalUpdateResponse'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Version conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /context/projects/{project_id}/status:
    get:
      summary: Get Project Status
      description: |
        Get current status and statistics of a project including
        version number, indexed files/symbols count, and last update time.
      tags:
        - Context Management
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
          description: Unique project identifier
      responses:
        '200':
          description: Status retrieved successfully
          headers:
            X-Request-ID:
              schema:
                type: string
                format: uuid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectStatusResponse'
        '404':
          description: Project not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Delete Project
      description: |
        Delete a project and all its symbols, relationships, and metadata.
        This operation is idempotent - returns 204 even if project doesn't exist.

        **Use case:** Re-indexing workflow - delete old project data before re-initializing
      operationId: deleteProject
      tags:
        - Context Management
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
          description: Unique project identifier
      responses:
        '204':
          description: Project deleted successfully (or didn't exist)
          headers:
            X-Request-ID:
              schema:
                type: string
                format: uuid
        '503':
          description: Service unavailable - database error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================================================
  # FEATURE 1: Test Generation (Preserved)
  # ============================================================================
  /workflows/generate-tests:
    post:
      summary: Generate tests (Async)
      description: |
        Triggers the test generation workflow.
        Used for:
        1. New test generation (Feature 1).
        2. Regenerating broken tests detected by Impact Analysis (Feature 3).
      tags:
        - Feature 1 - Generation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateTestsRequest'
      responses:
        '202':
          description: Task accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncJobResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================================================
  # FEATURE 2: Coverage Optimization (Optimized)
  # ============================================================================
  /optimization/coverage:
    post:
      summary: Optimize coverage (Async)
      description: |
        Frontend parses `coverage.xml` locally and sends uncovered ranges.
        Backend generates targeted test cases to fill these gaps.
      tags:
        - Feature 2 - Coverage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CoverageOptimizationRequest'
      responses:
        '202':
          description: Optimization task started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncJobResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================================================
  # FEATURE 3: Impact Analysis (Optimized)
  # ============================================================================
  /analysis/impact:
    post:
      summary: Analyze Test Impact
      description: |
        **Read-Only Analysis.**
        Frontend provides file changes (Git diffs) and relevant test file contents.
        Backend determines which tests are impacted and why.

        *Note: To fix/regenerate tests, use `/workflows/generate-tests`.*
      tags:
        - Feature 3 - Impact
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImpactAnalysisRequest'
      responses:
        '200':
          description: Analysis completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImpactAnalysisResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================================================
  # FEATURE 4: Quality Analysis (Optimized)
  # ============================================================================
  /quality/analyze:
    post:
      summary: Batch Quality Analysis
      description: |
        Analyzes multiple files for defects and redundancies.
        Returns issues with **embedded fix suggestions** for zero-latency UI interactions.
      tags:
        - Feature 4 - Quality
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QualityAnalysisRequest'
      responses:
        '200':
          description: Analysis completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QualityAnalysisResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  # ============================================================================
  # SHARED TASK POLLING
  # ============================================================================
  /tasks/{task_id}:
    get:
      summary: Poll Async Task Status
      description: Retrieve status and results for Feature 1 and Feature 2 workflows.
      tags:
        - Tasks
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Task status or result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskStatusResponse'
        '404':
          description: Task not found

# ============================================================================
# COMPONENTS
# ============================================================================
components:
  schemas:
    # ----------------------------------------
    # Shared Schemas
    # ----------------------------------------
    ErrorResponse:
      type: object
      required:
        - error
        - error_code
        - request_id
        - timestamp
        - path
      properties:
        error:
          type: string
          description: Human-readable error message
        error_code:
          type: string
          description: Machine-readable error code
          enum:
            - EMPTY_FILES
            - NO_SYMBOLS
            - PROJECT_EXISTS
            - PROJECT_NOT_FOUND
            - VERSION_CONFLICT
            - VALIDATION_ERROR
            - DB_CONNECTION_ERROR
            - DB_QUERY_ERROR
            - INTERNAL_ERROR
        details:
          type: object
          description: Additional error context
        request_id:
          type: string
          format: uuid
          description: Unique request identifier for tracing
        timestamp:
          type: string
          format: date-time
          description: Error timestamp in ISO 8601 format
        path:
          type: string
          description: Request path where error occurred
        suggestion:
          type: string
          description: Suggested action to resolve the error

    AsyncJobResponse:
      type: object
      required:
        - task_id
        - status
      properties:
        task_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, processing]
        estimated_time_seconds:
          type: integer

    TaskStatusResponse:
      type: object
      required:
        - task_id
        - status
      properties:
        task_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, processing, completed, failed]
        created_at:
          type: string
          format: date-time
        result:
          oneOf:
            - $ref: '#/components/schemas/GenerateTestsResult'
            - $ref: '#/components/schemas/CoverageOptimizationResult'
          description: |
            Task result varies by feature type:
            - Feature 1 (Test Generation): Returns GenerateTestsResult with generated_code and explanation
            - Feature 2 (Coverage Optimization): Returns CoverageOptimizationResult with recommended_tests array
            Only present when status is 'completed'.
        error:
          type: object
          properties:
            message:
              type: string
            code:
              type: string

    # ----------------------------------------
    # Phase 1: Context Management Schemas
    # ----------------------------------------
    SymbolInfo:
      type: object
      required:
        - name
        - kind
        - line_start
        - line_end
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
          description: Symbol name (function/class/method name)
        kind:
          type: string
          enum: [function, class, method]
          description: Symbol type
        signature:
          type: string
          maxLength: 500
          description: Function signature with type hints
        line_start:
          type: integer
          minimum: 0
          description: Start line number (0-based)
        line_end:
          type: integer
          minimum: 0
          description: End line number (0-based)
        calls:
          type: array
          items:
            type: string
          description: Names of functions called by this symbol
          default: []

    FileSymbols:
      type: object
      required:
        - path
        - symbols
      properties:
        path:
          type: string
          pattern: '^[\w\-./]+\.py$'
          description: File path relative to workspace (must be .py file)
        symbols:
          type: array
          minItems: 0
          maxItems: 1000
          items:
            $ref: '#/components/schemas/SymbolInfo'
          description: List of symbols extracted from this file

    InitializeProjectRequest:
      type: object
      required:
        - project_id
        - workspace_path
        - files
      properties:
        project_id:
          type: string
          minLength: 1
          maxLength: 100
          description: Unique project identifier
        workspace_path:
          type: string
          description: Absolute path to workspace directory
        language:
          type: string
          enum: [python]
          default: python
          description: Programming language (currently only Python supported)
        files:
          type: array
          minItems: 1
          maxItems: 5000
          items:
            $ref: '#/components/schemas/FileSymbols'
          description: List of files with their symbols to index

    InitializeProjectResponse:
      type: object
      required:
        - project_id
        - status
        - indexed_files
        - indexed_symbols
        - processing_time_ms
      properties:
        project_id:
          type: string
          description: Project identifier
        status:
          type: string
          enum: [initialized, already_exists]
          description: Initialization status
        indexed_files:
          type: integer
          minimum: 0
          description: Number of files indexed
        indexed_symbols:
          type: integer
          minimum: 0
          description: Number of symbols created
        processing_time_ms:
          type: integer
          minimum: 0
          description: Processing time in milliseconds

    SymbolChange:
      type: object
      required:
        - action
        - symbol
      properties:
        action:
          type: string
          enum: [added, modified, deleted]
          description: Type of change applied to the symbol
        symbol:
          $ref: '#/components/schemas/SymbolInfo'

    FileChange:
      type: object
      required:
        - file_path
        - action
      properties:
        file_path:
          type: string
          description: Path to the changed file
        action:
          type: string
          enum: [modified, deleted]
          description: Type of file change
        symbols_changed:
          type: array
          items:
            $ref: '#/components/schemas/SymbolChange'
          description: List of symbol changes within the file

    IncrementalUpdateRequest:
      type: object
      required:
        - version
        - changes
      properties:
        version:
          type: integer
          minimum: 1
          description: Current backend version for optimistic locking
        changes:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FileChange'
          description: List of file changes to apply

    IncrementalUpdateResponse:
      type: object
      required:
        - project_id
        - version
        - updated_at
        - changes_applied
        - processing_time_ms
      properties:
        project_id:
          type: string
          description: Project identifier
        version:
          type: integer
          description: New backend version after update
        updated_at:
          type: string
          format: date-time
          description: Timestamp of the update
        changes_applied:
          type: integer
          description: Number of changes successfully applied
        processing_time_ms:
          type: integer
          description: Processing time in milliseconds

    ProjectStatusResponse:
      type: object
      required:
        - project_id
        - status
        - indexed_files
        - indexed_symbols
        - last_updated_at
        - backend_version
      properties:
        project_id:
          type: string
          description: Project identifier
        status:
          type: string
          enum: [active, indexing, error]
          description: Current project status
        indexed_files:
          type: integer
          description: Total number of indexed files
        indexed_symbols:
          type: integer
          description: Total number of indexed symbols
        last_updated_at:
          type: string
          format: date-time
          description: Last update timestamp
        backend_version:
          type: integer
          description: Current backend version for optimistic locking

    # ----------------------------------------
    # Feature 1 Schemas
    # ----------------------------------------
    GenerateTestsRequest:
      type: object
      required:
        - source_code
      properties:
        source_code:
          type: string
          description: The Python source code to test.
        user_description:
          type: string
          description: Optional hint or requirement from user.
        existing_test_code:
          type: string
          description: Optional existing test code (context for regeneration).
        context:
          type: object
          description: Extra context if triggered by Feature 3 (Regeneration).
          properties:
            mode:
              type: string
              enum: [new, regenerate]
              default: new
            target_function:
              type: string

    GenerateTestsResult:
      type: object
      properties:
        generated_code:
          type: string
          description: The complete generated test file content.
        explanation:
          type: string

    # ----------------------------------------
    # Feature 2 Schemas (Optimized)
    # ----------------------------------------
    CoverageOptimizationRequest:
      type: object
      required:
        - source_code
        - uncovered_ranges
      properties:
        source_code:
          type: string
          description: Target source file content.
        existing_test_code:
          type: string
          description: Current test file content.
        uncovered_ranges:
          type: array
          description: Ranges parsed by Frontend from coverage.xml.
          items:
            type: object
            properties:
              start_line:
                type: integer
              end_line:
                type: integer
              type:
                type: string
                enum: [line, branch]
        framework:
          type: string
          enum: [pytest, unittest]
          default: pytest

    CoverageOptimizationResult:
      type: object
      properties:
        recommended_tests:
          type: array
          items:
            type: object
            properties:
              test_code:
                type: string
                description: The code snippet for the new test case.
              target_line:
                type: integer
                description: Recommended line number to insert the ghost text.
              scenario_description:
                type: string
              expected_coverage_impact:
                type: string
                example: "Covers exception handling in calculate_tax"

    # ----------------------------------------
    # Feature 3 Schemas (Optimized)
    # ----------------------------------------
    ImpactAnalysisRequest:
      type: object
      required:
        - project_context
      properties:
        project_context:
          type: object
          required:
            - files_changed
          properties:
            files_changed:
              type: array
              items:
                type: object
                required:
                  - path
                  - diff_content
                properties:
                  path:
                    type: string
                    example: "src/utils.py"
                  diff_content:
                    type: string
                    description: "Raw git diff string for this file."
            related_tests:
              type: array
              description: |
                Frontend uses static analysis (regex/AST) to guess which test files might be relevant
                and sends their content here for the LLM to confirm impact.
              items:
                type: object
                required:
                  - path
                  - content
                properties:
                  path:
                    type: string
                  content:
                    type: string

    ImpactAnalysisResponse:
      type: object
      required:
        - impacted_tests
      properties:
        impacted_tests:
          type: array
          items:
            type: object
            properties:
              file_path:
                type: string
                description: Path to the test file.
              test_case_name:
                type: string
                description: Name of the specific test function affected.
              severity:
                type: string
                enum: [critical, high, medium, low]
                description: Used for UI coloring (Red/Orange/Yellow).
              reason:
                type: string
                description: Human-readable reason (e.g., "Function signature changed").
        suggested_action:
          type: string
          enum: [none, regenerate]
          description: Recommendation for the UI button state.

    # ----------------------------------------
    # Feature 4 Schemas (Optimized)
    # ----------------------------------------
    QualityAnalysisRequest:
      type: object
      required:
        - files
      properties:
        files:
          type: array
          items:
            type: object
            required:
              - path
              - content
            properties:
              path:
                type: string
              content:
                type: string
        mode:
          type: string
          enum: [fast, deep, hybrid]
          default: hybrid
          description: |
            fast: Rules only (e.g., On-Save).
            deep: LLM only.
            hybrid: Recommended default.

    QualityAnalysisResponse:
      type: object
      required:
        - issues
        - summary
      properties:
        analysis_id:
          type: string
        summary:
          type: object
          properties:
            total_files:
              type: integer
            total_issues:
              type: integer
            critical_issues:
              type: integer
        issues:
          type: array
          items:
            $ref: '#/components/schemas/QualityIssue'

    QualityIssue:
      type: object
      required:
        - file_path
        - line
        - severity
        - message
        - code
      properties:
        file_path:
          type: string
        line:
          type: integer
          description: 1-based line number.
        column:
          type: integer
          default: 0
        severity:
          type: string
          enum: [error, warning, info]
        code:
          type: string
          example: "redundant-assertion"
        message:
          type: string
        detected_by:
          type: string
          enum: [rule, llm]
        suggestion:
          $ref: '#/components/schemas/FixSuggestion'

    FixSuggestion:
      type: object
      nullable: true
      properties:
        type:
          type: string
          enum: [replace, delete, insert]
        new_text:
          type: string
          description: The code to apply.
        description:
          type: string
          description: 'Menu label (e.g., "Fix: Remove redundancy").'

  responses:
    BadRequest:
      description: Invalid request format or parameters.
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              details:
                type: object
